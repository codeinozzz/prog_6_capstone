<section class="waiting-room">
  <h1 class="waiting-room__title">Waiting Room</h1>

  @if (errorMessage) {
    <div class="error-message">
      {{ errorMessage }}
    </div>
  }

  @if (!currentRoom) {
    <!-- PHASE A: Room list -->
    <div class="waiting-room__create">
      <h2>Create Room</h2>
      <div class="waiting-room__create-form">
        <input
          class="waiting-room__input"
          [(ngModel)]="newRoomName"
          placeholder="Room name"
        />
        <select class="waiting-room__select" [(ngModel)]="selectedMap">
          <option value="desert">Desert</option>
          <option value="night_city">Night City</option>
          <option value="forest">Forest</option>
        </select>
        <button class="waiting-room__button" (click)="createRoom()" [disabled]="loading">Create</button>
      </div>
    </div>

    <div class="waiting-room__rooms">
      <h2>Available Rooms</h2>
      @if (rooms.length === 0) {
        <p class="waiting-room__empty">No rooms available</p>
      }
      <ul class="waiting-room__list">
        @for (room of rooms; track room.id) {
          <li class="waiting-room__room-item">
            <span class="waiting-room__room-name">{{ room.roomName }}</span>
            <span class="waiting-room__room-players">{{ room.currentPlayers }}/{{ room.maxPlayers }}</span>
            <span class="waiting-room__room-status">{{ room.status }}</span>
            <button class="waiting-room__button" (click)="joinRoom(room)" [disabled]="loading">Join</button>
            <button class="waiting-room__button waiting-room__button--danger" (click)="deleteRoom(room.id)" [disabled]="loading">Delete</button>
          </li>
        }
      </ul>
    </div>
  } @else {
    <!-- PHASE B: Lobby (inside a room) -->
    <div class="waiting-room__lobby">
      <div class="waiting-room__lobby-header">
        <h2>{{ currentRoom.roomName }}</h2>
        <span class="waiting-room__lobby-map">Map: {{ currentRoom.mapName ?? selectedMap }}</span>
        <button class="waiting-room__button" (click)="leaveRoom()">Leave</button>
      </div>

      <div class="waiting-room__players">
        <h3>Players Connected</h3>
        <ul class="waiting-room__list">
          @for (player of players(); track player.id) {
            <li class="waiting-room__player-item">
              {{ player.name }}
              @if (player.isLocal) {
                <span class="waiting-room__player-you">(You)</span>
              }
            </li>
          }
        </ul>
      </div>

      <button class="waiting-room__button waiting-room__button--start" (click)="startGame()">
        Start Game
      </button>

      <!-- Historial de la sala (Redis) -->
      @if (roomHistory.length > 0) {
        <div class="waiting-room__history">
          <h3>Room History (via Redis)</h3>
          <ul class="waiting-room__history-list">
            @for (event of roomHistory; track event.timestamp) {
              <li class="waiting-room__history-item">
                <span class="waiting-room__history-type">{{ event.type }}</span>
                <span class="waiting-room__history-text">{{ formatHistoryPayload(event) }}</span>
              </li>
            }
          </ul>
        </div>
      }
    </div>
  }

  <div class="waiting-room__chat">
    <h2 class="waiting-room__chat-title">Chat</h2>
    <div class="waiting-room__chat-messages">
      @for (message of chatMessages(); track message.timestamp) {
        <p class="waiting-room__chat-message">
          <strong>{{ message.sender }}:</strong> {{ message.text }}
        </p>
      }
    </div>

    <form class="waiting-room__chat-form" (ngSubmit)="sendMessage()">
      <input
        class="waiting-room__chat-input"
        name="message"
        [(ngModel)]="messageText"
        placeholder="Type a message..."
        autocomplete="off"
      />
      <button class="waiting-room__chat-button" type="submit">Send</button>
    </form>
  </div>
</section>
